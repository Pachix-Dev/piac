---
import i18next, { t, changeLanguage } from "i18next";
import LayoutRecuerdos from "../layouts/LayoutRecuerdos.astro";
import { recuerdos } from "../data/data_recuerdos";
import "../components/recuerdos/gallery.css";

changeLanguage("es");

const currentLanguage = i18next.language;
const items = recuerdos.map((item) => {
    return {
        id: item.id,
        title: item.title,
        title_en: item.title_en,
        src: item.img,
        thumb: item.img,
        year: item.year,
        subHtml: `<div class="lightGallery-captions">
                <h3>${currentLanguage === "es" ? item.title : item.title_en}</h3>
                <p>${currentLanguage === "es" ? item.subtitle : item.subtitle_en}</p>
            </div>`,
    };
});
// Obtener años únicos y ordenarlos
const years = [...new Set(recuerdos.map(item => item.year))].sort((a, b) => b.localeCompare(a));
---

<LayoutRecuerdos>
  <div class='min-h-screen bg-gradient-to-br from-gray-50 to-gray-100'>
    <!-- Header Section -->
    <div class='container mx-auto px-4 py-8 lg:px-8 lg:py-12'>
      <div class='text-center mb-12'>
        <h1
          class='text-4xl md:text-5xl lg:text-6xl font-bold text-gray-800 mb-6 relative inline-block'
          data-aos='fade-down'
          data-aos-duration='1000'
        >
          {t('memories.title')}
          <div class='absolute bottom-0 left-1/2 transform -translate-x-1/2 w-24 h-1 bg-gradient-to-r from-green-500 to-green-700 rounded-full'></div>
        </h1>
        <p 
          class='text-lg md:text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed' 
          data-aos='fade-up' 
          data-aos-duration='1000'
          data-aos-delay='200'
        >
          {t('memories.subtitle')}
        </p>
      </div>

      <!-- Filter Section -->
      <div 
        class='mb-12' 
        data-aos='fade-up' 
        data-aos-duration='800'
        data-aos-delay='400'
      >
        <div class='bg-white rounded-2xl shadow-lg p-6 md:p-8'>
          <h3 class='text-lg font-semibold text-gray-800 mb-6 text-center'>
            Filtrar por año
          </h3>
          <div class='flex flex-wrap justify-center gap-3 years'>
            <button 
              data-year='all' 
              onclick="setFilter('all')" 
              class='filter-btn active px-6 py-3 rounded-full font-medium transition-all duration-300 bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-200'
            > 
              Todos 
            </button>
            {years.map(year => (
              <button 
                data-year={year} 
                onclick={`setFilter('${year}')`} 
                class='filter-btn px-6 py-3 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-200'
              > 
                {year} 
              </button>
            ))}
          </div>
          <!-- Results counter -->
          <div class='mt-4 text-center'>
            <span id='results-counter' class='text-sm text-gray-500'>
              Mostrando {items.length} recuerdos
            </span>
          </div>
        </div>
      </div>

      <!-- Gallery Section -->
      <div 
        class='gallery-container' 
        data-aos='fade-up' 
        data-aos-duration='1000'
        data-aos-delay='600'
      >
        <div id='lightgallery' class='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6'>
          {items.map((recuerdo, index) => (
            <a
              href={recuerdo.src}
              class='item group relative overflow-hidden rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2'
              data-sub-html={recuerdo.subHtml}
              data-year={recuerdo.year}
              data-aos='zoom-in'
              data-aos-duration='600'
              data-aos-delay={index * 50}
            >
              <div class='aspect-square relative overflow-hidden'>
                <img
                  alt={recuerdo.title}
                  src={recuerdo.src}
                  loading='lazy'
                  class='w-full h-full object-cover transition-transform duration-500 group-hover:scale-110'
                />
                <!-- Overlay -->
                <div class='absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300'>
                  <div class='absolute bottom-0 left-0 right-0 p-4'>
                    <h4 class='text-white font-semibold text-sm mb-1 truncate'>
                      {currentLanguage === "es" ? recuerdo.title : recuerdo.title_en}
                    </h4>
                    <p class='text-white/80 text-xs'>
                      {recuerdo.year}
                    </p>
                  </div>
                </div>
                <!-- Zoom icon -->
                <div class='absolute top-3 right-3 bg-white/20 backdrop-blur-sm rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300'>
                  <svg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5 text-white' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7' />
                  </svg>
                </div>
              </div>
            </a>
          ))}
        </div>

        <!-- No results message -->
        <div id='no-results' class='hidden text-center py-12'>
          <div class='bg-white rounded-2xl shadow-lg p-8 max-w-md mx-auto'>
            <svg xmlns='http://www.w3.org/2000/svg' class='h-16 w-16 text-gray-400 mx-auto mb-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.674-2.646M8.326 16.172a4 4 0 015.656 0' />
            </svg>
            <h3 class='text-lg font-semibold text-gray-700 mb-2'>No se encontraron recuerdos</h3>
            <p class='text-gray-500'>No hay recuerdos para el año seleccionado.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to top button -->
    <button
      id='back-to-top'
      class='fixed bottom-8 right-8 z-50 bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg transition-all duration-300 transform scale-0 hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-200'
      onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
      aria-label='Volver arriba'
    >
      <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'>
        <path stroke-linecap='round' stroke-linejoin='round' d='M5 15l7-7 7 7'></path>
      </svg>
    </button>
  </div>
</LayoutRecuerdos>

<script is:inline data-astro-rerun>
  function setFilter(year) {
    const items = document.querySelectorAll('.item');
    const buttons = document.querySelectorAll('.filter-btn');
    const noResults = document.getElementById('no-results');
    const counter = document.getElementById('results-counter');
    let visibleCount = 0;

    // Reset button styles
    buttons.forEach(btn => {
      btn.classList.remove('active', 'bg-green-600', 'text-white');
      btn.classList.add('bg-gray-200', 'text-gray-700');
    });

    // Set active button
    const activeBtn = document.querySelector(`[data-year="${year}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active', 'bg-green-600', 'text-white');
      activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
    }

    // Filter items - OPTIMIZADO: Sin animaciones escalonadas
    items.forEach((item) => {
      const itemYear = item.dataset.year;
      const shouldShow = year === 'all' || itemYear === year;
      
      if (shouldShow) {
        item.style.display = 'block';
        item.style.opacity = '1';
        item.style.transform = 'scale(1)';
        visibleCount++;
      } else {
        item.style.display = 'none';
        item.style.opacity = '0';
        item.style.transform = 'scale(0.8)';
      }
    });

    // Update counter and show/hide no results - INMEDIATO
    if (visibleCount === 0) {
      noResults.classList.remove('hidden');
      counter.textContent = 'No hay recuerdos para mostrar';
    } else {
      noResults.classList.add('hidden');
      counter.textContent = `Mostrando ${visibleCount} recuerdo${visibleCount !== 1 ? 's' : ''}`;
    }
  }

  // Back to top button visibility
  window.addEventListener('scroll', () => {
    const backToTop = document.getElementById('back-to-top');
    if (window.scrollY > 300) {
      backToTop.style.transform = 'scale(1)';
    } else {
      backToTop.style.transform = 'scale(0)';
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    setFilter('all');
  });
</script>

<style>
  .item {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .filter-btn:hover {
    transform: translateY(-1px);
  }
  
  .gallery-container {
    min-height: 400px;
  }
  
  @media (max-width: 640px) {
    .years {
      max-height: 200px;
      overflow-y: auto;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  }
</style>